#!/bin/bash
sudo apt-get install stress

indent() {
  sed -u 's/^/       /'
}

echo "-----> allocating 100Gb of memory total"
for i in {1..10}
do
  echo "-----> step $i: allocating 10Gb of memory"
  dd if=/dev/zero of=/dev/null bs=1G count=10
  echo CPU: `top -b -n1 | grep "Cpu(s)" | awk '{print $2 + $4}'`
  FREE_DATA=`free -m | grep Mem`
  CURRENT=`echo $FREE_DATA | cut -f3 -d' '`
  TOTAL=`echo $FREE_DATA | cut -f2 -d' '`
  echo RAM: $(echo "scale = 2; $CURRENT/$TOTAL*100" | bc)
  echo HDD: `df -lh | awk '{if ($6 == "/") { print $5 }}' | head -1 | cut -d'%' -f1`
  echo "sleeping for 5 seconds" | indent
  sleep 5
done

echo "-----> Memory consumption complete!"
echo "Something should have broken by now." | indent
